!function(){var e={},t=function(t){for(var n=e[t],r=n.deps,o=n.defn,a=r.length,s=new Array(a),l=0;l<a;++l)s[l]=i(r[l]);var c=o.apply(null,s);if(void 0===c)throw"module ["+t+"] returned undefined";n.instance=c},n=function(t,n,i){if("string"!=typeof t)throw"module id must be a string";if(void 0===n)throw"no dependencies for "+t;if(void 0===i)throw"no definition function for "+t;e[t]={deps:n,defn:i,instance:void 0}},i=function(n){var i=e[n];if(void 0===i)throw"module ["+n+"] was undefined";return void 0===i.instance&&t(n),i.instance},r=function(e,t){for(var n=e.length,r=new Array(n),o=0;o<n;++o)r.push(i(e[o]));t.apply(null,t)},o={};o.bolt={module:{api:{define:n,require:r,demand:i}}};var a=n,s=function(e,t){a(e,[],function(){return t})};s("1",tinymce.PluginManager),s("2",tinymce.Env),s("3",tinymce.util.Promise),s("4",tinymce.util.URI),s("5",tinymce.util.Tools),s("6",tinymce.util.Delay),a("m",[],function(){function e(e,t){return i(document.createElement("canvas"),e,t)}function t(e){return e.getContext("2d")}function n(e){var t=null;try{t=e.getContext("webgl")||e.getContext("experimental-webgl")}catch(e){}return t||(t=null),t}function i(e,t,n){return e.width=t,e.height=n,e}return{create:e,resize:i,get2dContext:t,get3dContext:n}}),a("n",[],function(){function e(e){return e.naturalWidth||e.width}function t(e){return e.naturalHeight||e.height}return{getWidth:e,getHeight:t}}),a("o",[],function(){function e(e,t){return function(){e.apply(t,arguments)}}function t(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],s(t,e(i,this),e(r,this))}function n(e){var t=this;return null===this._state?void this._deferreds.push(e):void l(function(){var n=t._state?e.onFulfilled:e.onRejected;if(null===n)return void(t._state?e.resolve:e.reject)(t._value);var i;try{i=n(t._value)}catch(t){return void e.reject(t)}e.resolve(i)})}function i(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if("function"==typeof n)return void s(e(n,t),e(i,this),e(r,this))}this._state=!0,this._value=t,o.call(this)}catch(e){r.call(this,e)}}function r(e){this._state=!1,this._value=e,o.call(this)}function o(){for(var e=0,t=this._deferreds.length;e<t;e++)n.call(this,this._deferreds[e]);this._deferreds=null}function a(e,t,n,i){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.resolve=n,this.reject=i}function s(e,t,n){var i=!1;try{e(function(e){i||(i=!0,t(e))},function(e){i||(i=!0,n(e))})}catch(e){if(i)return;i=!0,n(e)}}if(window.Promise)return window.Promise;var l=t.immediateFn||"function"==typeof setImmediate&&setImmediate||function(e){setTimeout(e,1)},c=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};return t.prototype["catch"]=function(e){return this.then(null,e)},t.prototype.then=function(e,i){var r=this;return new t(function(t,o){n.call(r,new a(e,i,t,o))})},t.all=function(){var e=Array.prototype.slice.call(1===arguments.length&&c(arguments[0])?arguments[0]:arguments);return new t(function(t,n){function i(o,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var s=a.then;if("function"==typeof s)return void s.call(a,function(e){i(o,e)},n)}e[o]=a,0===--r&&t(e)}catch(e){n(e)}}if(0===e.length)return t([]);for(var r=e.length,o=0;o<e.length;o++)i(o,e[o])})},t.resolve=function(e){return e&&"object"==typeof e&&e.constructor===t?e:new t(function(t){t(e)})},t.reject=function(e){return new t(function(t,n){n(e)})},t.race=function(e){return new t(function(t,n){for(var i=0,r=e.length;i<r;i++)e[i].then(t,n)})},t}),a("p",[],function(){function e(e){var t=document.createElement("a");return t.href=e,t.pathname}function t(t){var n=e(t).split("."),i=n[n.length-1],r={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png"};return i&&(i=i.toLowerCase()),r[i]}return{guessMimeType:t}}),a("e",["o","m","p","n"],function(e,t,n,i){function r(t){return new e(function(e){function n(){t.removeEventListener("load",n),e(t)}t.complete?e(t):t.addEventListener("load",n)})}function o(e){return r(e).then(function(e){var n,r;return r=t.create(i.getWidth(e),i.getHeight(e)),n=t.get2dContext(r),n.drawImage(e,0,0),r})}function a(e){return r(e).then(function(e){var t=e.src;return 0===t.indexOf("blob:")?l(t):0===t.indexOf("data:")?c(t):o(e).then(function(e){return c(e.toDataURL(n.guessMimeType(t)))})})}function s(t){return new e(function(e){function n(){i.removeEventListener("load",n),e(i)}var i=new Image;i.addEventListener("load",n),i.src=URL.createObjectURL(t),i.complete&&n()})}function l(t){return new e(function(e){var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="blob",n.onload=function(){200==this.status&&e(this.response)},n.send()})}function c(t){return new e(function(e){var n,i,r,o,a,s;if(t=t.split(","),o=/data:([^;]+)/.exec(t[0]),o&&(a=o[1]),n=atob(t[1]),window.WebKitBlobBuilder){for(s=new WebKitBlobBuilder,i=new ArrayBuffer(n.length),r=0;r<i.length;r++)i[r]=n.charCodeAt(r);return s.append(i),void e(s.getBlob(a))}for(i=new Uint8Array(n.length),r=0;r<i.length;r++)i[r]=n.charCodeAt(r);e(new Blob([i],{type:a}))})}function u(e){return 0===e.indexOf("blob:")?l(e):0===e.indexOf("data:")?c(e):null}function d(e,t){return c(e.toDataURL(t))}function f(t){return new e(function(e){var n=new FileReader;n.onloadend=function(){e(n.result)},n.readAsDataURL(t)})}function h(e){return f(e).then(function(e){return e.split(",")[1]})}function p(e){URL.revokeObjectURL(e.src)}return{blobToImage:s,imageToBlob:a,blobToDataUri:f,blobToBase64:h,imageToCanvas:o,canvasToBlob:d,revokeImageUrl:p,uriToBlob:u}}),a("q",[],function(){function e(e,t,n){return e=parseFloat(e),e>n?e=n:e<t&&(e=t),e}function t(){return[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1]}function n(e,t){var n,i,r,o,a=[],s=new Array(10);for(n=0;n<5;n++){for(i=0;i<5;i++)a[i]=t[i+5*n];for(i=0;i<5;i++){for(o=0,r=0;r<5;r++)o+=e[i+5*r]*a[r];s[i+5*n]=o}}return s}function i(t,n){return n=e(n,0,1),t.map(function(t,i){return i%6===0?t=1-(1-t)*n:t*=n,e(t,0,1)})}function r(t,i){var r;return i=e(i,-1,1),i*=100,i<0?r=127+i/100*127:(r=i%1,r=0===r?d[i]:d[Math.floor(i)]*(1-r)+d[Math.floor(i)+1]*r,r=127*r+127),n(t,[r/127,0,0,0,.5*(127-r),0,r/127,0,0,.5*(127-r),0,0,r/127,0,.5*(127-r),0,0,0,1,0,0,0,0,0,1])}function o(t,i){var r,o,a,s;return i=e(i,-1,1),r=1+(i>0?3*i:i),o=.3086,a=.6094,s=.082,n(t,[o*(1-r)+r,a*(1-r),s*(1-r),0,0,o*(1-r),a*(1-r)+r,s*(1-r),0,0,o*(1-r),a*(1-r),s*(1-r)+r,0,0,0,0,0,1,0,0,0,0,0,1])}function a(t,i){var r,o,a,s,l;return i=e(i,-180,180)/180*Math.PI,r=Math.cos(i),o=Math.sin(i),a=.213,s=.715,l=.072,n(t,[a+r*(1-a)+o*-a,s+r*-s+o*-s,l+r*-l+o*(1-l),0,0,a+r*-a+.143*o,s+r*(1-s)+.14*o,l+r*-l+o*-.283,0,0,a+r*-a+o*-(1-a),s+r*-s+o*s,l+r*(1-l)+o*l,0,0,0,0,0,1,0,0,0,0,0,1])}function s(t,i){return i=e(255*i,-255,255),n(t,[1,0,0,0,i,0,1,0,0,i,0,0,1,0,i,0,0,0,1,0,0,0,0,0,1])}function l(t,i,r,o){return i=e(i,0,2),r=e(r,0,2),o=e(o,0,2),n(t,[i,0,0,0,0,0,r,0,0,0,0,0,o,0,0,0,0,0,1,0,0,0,0,0,1])}function c(t,r){return r=e(r,0,1),n(t,i([.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0,0,0,0,0,1],r))}function u(t,r){return r=e(r,0,1),n(t,i([.33,.34,.33,0,0,.33,.34,.33,0,0,.33,.34,.33,0,0,0,0,0,1,0,0,0,0,0,1],r))}var d=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10];return{identity:t,adjust:i,multiply:n,adjustContrast:r,adjustBrightness:s,adjustSaturation:o,adjustHue:a,adjustColors:l,adjustSepia:c,adjustGrayscale:u}}),a("c",["m","n","e","q"],function(e,t,n,i){function r(i,r){return n.blobToImage(i).then(function(i){function o(e,t){var n,i,r,o,a,s=e.data,l=t[0],c=t[1],u=t[2],d=t[3],f=t[4],h=t[5],p=t[6],m=t[7],g=t[8],v=t[9],y=t[10],b=t[11],C=t[12],w=t[13],x=t[14],_=t[15],S=t[16],k=t[17],E=t[18],T=t[19];for(a=0;a<s.length;a+=4)n=s[a],i=s[a+1],r=s[a+2],o=s[a+3],s[a]=n*l+i*c+r*u+o*d+f,s[a+1]=n*h+i*p+r*m+o*g+v,s[a+2]=n*y+i*b+r*C+o*w+x,s[a+3]=n*_+i*S+r*k+o*E+T;return e}var a,s=e.create(t.getWidth(i),t.getHeight(i)),l=e.get2dContext(s);return l.drawImage(i,0,0),u(i),a=o(l.getImageData(0,0,s.width,s.height),r),l.putImageData(a,0,0),n.canvasToBlob(s)})}function o(i,r){return n.blobToImage(i).then(function(i){function o(e,t,n){function i(e,t,n){return e>n?e=n:e<t&&(e=t),e}var r,o,a,s,l,c,u,d,f,h,p,m,g,v,y,b,C;for(a=Math.round(Math.sqrt(n.length)),s=Math.floor(a/2),r=e.data,o=t.data,b=e.width,C=e.height,c=0;c<C;c++)for(l=0;l<b;l++){for(u=d=f=0,p=0;p<a;p++)for(h=0;h<a;h++)m=i(l+h-s,0,b-1),g=i(c+p-s,0,C-1),v=4*(g*b+m),y=n[p*a+h],u+=r[v]*y,d+=r[v+1]*y,f+=r[v+2]*y;v=4*(c*b+l),o[v]=i(u,0,255),o[v+1]=i(d,0,255),o[v+2]=i(f,0,255)}return t}var a,s,l=e.create(t.getWidth(i),t.getHeight(i)),c=e.get2dContext(l);return c.drawImage(i,0,0),u(i),a=c.getImageData(0,0,l.width,l.height),s=c.getImageData(0,0,l.width,l.height),s=o(a,s,r),c.putImageData(s,0,0),n.canvasToBlob(l)})}function a(i){return function(r,o){return n.blobToImage(r).then(function(r){function a(e,t){var n,i=e.data;for(n=0;n<i.length;n+=4)i[n]=t[i[n]],i[n+1]=t[i[n+1]],i[n+2]=t[i[n+2]];return e}var s,l,c=e.create(t.getWidth(r),t.getHeight(r)),d=e.get2dContext(c),f=new Array(256);for(l=0;l<f.length;l++)f[l]=i(l,o);return d.drawImage(r,0,0),u(r),s=a(d.getImageData(0,0,c.width,c.height),f),d.putImageData(s,0,0),n.canvasToBlob(c)})}}function s(e){return function(t,n){return r(t,e(i.identity(),n))}}function l(e){return function(t){return r(t,e)}}function c(e){return function(t){return o(t,e)}}var u=n.revokeImageUrl;return{invert:l([-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0]),brightness:s(i.adjustBrightness),hue:s(i.adjustHue),saturate:s(i.adjustSaturation),contrast:s(i.adjustContrast),grayscale:s(i.adjustGrayscale),sepia:s(i.adjustSepia),colorize:function(e,t,n,o){return r(e,i.adjustColors(i.identity(),t,n,o))},sharpen:c([0,-1,0,-1,5,-1,0,-1,0]),emboss:c([-2,-1,0,-1,1,1,0,1,2]),gamma:a(function(e,t){return 255*Math.pow(e/255,1-t)}),exposure:a(function(e,t){return 255*(1-Math.exp(-(e/255)*t))}),colorFilter:r,convoluteFilter:o}}),a("r",["o","e","m","n"],function(e,t,n,i){function r(e,t,n){var a=i.getWidth(e),s=i.getHeight(e),l=t/a,c=n/s,u=!1;(l<.5||l>2)&&(l=l<.5?.5:2,u=!0),(c<.5||c>2)&&(c=c<.5?.5:2,u=!0);var d=o(e,l,c);return u?d.then(function(e){return r(e,t,n)}):d}function o(t,r,o){return new e(function(e){var a=i.getWidth(t),s=i.getHeight(t),l=Math.floor(a*r),c=Math.floor(s*o),u=n.create(l,c),d=n.get2dContext(u);d.drawImage(t,0,0,a,s,0,0,l,c),e(u)})}return{scale:r}}),a("d",["e","m","n","r"],function(e,t,n,i){function r(i,r){return e.blobToImage(i).then(function(o){var a=t.create(n.getWidth(o),n.getHeight(o)),s=t.get2dContext(a),c=0,u=0;return r=r<0?360+r:r,90!=r&&270!=r||t.resize(a,a.height,a.width),90!=r&&180!=r||(c=a.width),270!=r&&180!=r||(u=a.height),s.translate(c,u),s.rotate(r*Math.PI/180),s.drawImage(o,0,0),l(o),e.canvasToBlob(a,i.type)})}function o(i,r){return e.blobToImage(i).then(function(i){var o=t.create(n.getWidth(i),n.getHeight(i)),a=t.get2dContext(o);return"v"==r?(a.scale(1,-1),a.drawImage(i,0,-o.height)):(a.scale(-1,1),a.drawImage(i,-o.width,0)),l(i),e.canvasToBlob(o)})}function a(n,i,r,o,a){return e.blobToImage(n).then(function(n){var s=t.create(o,a),c=t.get2dContext(s);return c.drawImage(n,-i,-r),l(n),e.canvasToBlob(s)})}function s(t,n,r){return e.blobToImage(t).then(function(o){var a;return a=i.scale(o,n,r).then(function(n){return e.canvasToBlob(n,t.type)}).then(c(o))["catch"](c(o))})}var l=e.revokeImageUrl,c=function(e){return function(t){return l(e),t}};return{rotate:r,flip:o,crop:a,resize:s}}),a("7",["c","d"],function(e,t){var n=function(t){return e.invert(t)},i=function(t){return e.sharpen(t)},r=function(t){return e.emboss(t)},o=function(t,n){return e.gamma(t,n)},a=function(t,n){return e.exposure(t,n)},s=function(t,n,i,r){return e.colorize(t,n,i,r)},l=function(t,n){return e.brightness(t,n)},c=function(t,n){return e.hue(t,n)},u=function(t,n){return e.saturate(t,n)},d=function(t,n){return e.contrast(t,n)},f=function(t,n){return e.grayscale(t,n)},h=function(t,n){return e.sepia(t,n)},p=function(e,n){return t.flip(e,n)},m=function(e,n,i,r,o){return t.crop(e,n,i,r,o)},g=function(e,n,i){return t.resize(e,n,i)},v=function(e,n){return t.rotate(e,n)};return{invert:n,sharpen:i,emboss:r,brightness:l,hue:c,saturate:u,contrast:d,grayscale:f,sepia:h,colorize:s,gamma:o,exposure:a,flip:p,crop:m,resize:g,rotate:v}}),a("8",["e"],function(e){var t=function(t){return e.blobToImage(t)},n=function(t){return e.imageToBlob(t)},i=function(t){return e.blobToDataUri(t)},r=function(t){return e.blobToBase64(t)};return{blobToImage:t,imageToBlob:n,blobToDataUri:i,blobToBase64:r}}),s("f",tinymce.dom.DOMUtils),s("g",tinymce.ui.Factory),s("h",tinymce.ui.Form),s("i",tinymce.ui.Container),s("s",tinymce.ui.Control),s("t",tinymce.ui.DragHelper),s("u",tinymce.geom.Rect),s("w",tinymce.dom.DomQuery),s("x",tinymce.util.Observable),s("y",tinymce.util.VK),a("v",["w","t","u","5","x","y"],function(e,t,n,i,r,o){var a=0;return function(s,l,c,u,d){function f(e,t){return{x:t.x+e.x,y:t.y+e.y,w:t.w,h:t.h}}function h(e,t){return{x:t.x-e.x,y:t.y-e.y,w:t.w,h:t.h}}function p(){return h(c,s)}function m(e,t,i,r){var o,a,l,u,d;o=t.x,a=t.y,l=t.w,u=t.h,o+=i*e.deltaX,a+=r*e.deltaY,l+=i*e.deltaW,u+=r*e.deltaH,l<20&&(l=20),u<20&&(u=20),d=s=n.clamp({x:o,y:a,w:l,h:u},c,"move"==e.name),d=h(c,d),S.fire("updateRect",{rect:d}),w(d)}function g(){function n(e){var n;return new t(D,{document:u.ownerDocument,handle:D+"-"+e.name,start:function(){n=s},drag:function(t){m(e,n,t.deltaX,t.deltaY)}})}e('<div id="'+D+'" class="'+N+'croprect-container" role="grid" aria-dropeffect="execute">').appendTo(u),i.each(T,function(t){e("#"+D,u).append('<div id="'+D+"-"+t+'"class="'+N+'croprect-block" style="display: none" data-mce-bogus="all">')}),i.each(k,function(t){e("#"+D,u).append('<div id="'+D+"-"+t.name+'" class="'+N+"croprect-handle "+N+"croprect-handle-"+t.name+'"style="display: none" data-mce-bogus="all" role="gridcell" tabindex="-1" aria-label="'+t.label+'" aria-grabbed="false">')}),E=i.map(k,n),y(s),e(u).on("focusin focusout",function(t){e(t.target).attr("aria-grabbed","focus"===t.type)}),e(u).on("keydown",function(e){function t(e,t,i,r,o){e.stopPropagation(),e.preventDefault(),m(n,i,r,o)}var n;switch(i.each(k,function(t){if(e.target.id==D+"-"+t.name)return n=t,!1}),e.keyCode){case o.LEFT:t(e,n,s,-10,0);break;case o.RIGHT:t(e,n,s,10,0);break;case o.UP:t(e,n,s,0,-10);break;case o.DOWN:t(e,n,s,0,10);break;case o.ENTER:case o.SPACEBAR:e.preventDefault(),d()}})}function v(t){var n;n=i.map(k,function(e){return"#"+D+"-"+e.name}).concat(i.map(T,function(e){return"#"+D+"-"+e})).join(","),t?e(n,u).show():e(n,u).hide()}function y(t){function n(t,n){n.h<0&&(n.h=0),n.w<0&&(n.w=0),e("#"+D+"-"+t,u).css({left:n.x,top:n.y,width:n.w,height:n.h})}i.each(k,function(n){e("#"+D+"-"+n.name,u).css({left:t.w*n.xMul+t.x,top:t.h*n.yMul+t.y})}),n("top",{x:l.x,y:l.y,w:l.w,h:t.y-l.y}),n("right",{x:t.x+t.w,y:t.y,w:l.w-t.x-t.w+l.x,h:t.h}),n("bottom",{x:l.x,y:t.y+t.h,w:l.w,h:l.h-t.y-t.h+l.y}),n("left",{x:l.x,y:t.y,w:t.x-l.x,h:t.h}),n("move",t)}function b(e){s=e,y(s)}function C(e){l=e,y(s)}function w(e){b(f(c,e))}function x(e){c=e,y(s)}function _(){i.each(E,function(e){e.destroy()}),E=[]}var S,k,E,T,N="mce-",D=N+"crid-"+a++;return k=[{name:"move",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:0,deltaH:0,label:"Crop Mask"},{name:"nw",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:-1,deltaH:-1,label:"Top Left Crop Handle"},{name:"ne",xMul:1,yMul:0,deltaX:0,deltaY:1,deltaW:1,deltaH:-1,label:"Top Right Crop Handle"},{name:"sw",xMul:0,yMul:1,deltaX:1,deltaY:0,deltaW:-1,deltaH:1,label:"Bottom Left Crop Handle"},{name:"se",xMul:1,yMul:1,deltaX:0,deltaY:0,deltaW:1,deltaH:1,label:"Bottom Right Crop Handle"}],T=["top","right","bottom","left"],g(u),S=i.extend({toggleVisibility:v,setClampRect:x,setRect:b,getInnerRect:p,setInnerRect:w,setViewPortRect:C,destroy:_},r)}}),a("j",["s","t","u","5","3","v"],function(e,t,n,i,r,o){function a(e){return new r(function(t){function n(){e.removeEventListener("load",n),t(e)}e.complete?t(e):e.addEventListener("load",n)})}return e.extend({Defaults:{classes:"imagepanel"},selection:function(e){return arguments.length?(this.state.set("rect",e),this):this.state.get("rect")},imageSize:function(){var e=this.state.get("viewRect");return{w:e.w,h:e.h}},toggleCropRect:function(e){this.state.set("cropEnabled",e)},imageSrc:function(e){var t=this,i=new Image;i.src=e,a(i).then(function(){var e,r,o=t.state.get("viewRect");if(r=t.$el.find("img"),r[0])r.replaceWith(i);else{var a=document.createElement("div");a.className="mce-imagepanel-bg",t.getEl().appendChild(a),t.getEl().appendChild(i)}e={x:0,y:0,w:i.naturalWidth,h:i.naturalHeight},t.state.set("viewRect",e),t.state.set("rect",n.inflate(e,-20,-20)),o&&o.w==e.w&&o.h==e.h||t.zoomFit(),t.repaintImage(),t.fire("load")})},zoom:function(e){return arguments.length?(this.state.set("zoom",e),this):this.state.get("zoom")},postRender:function(){return this.imageSrc(this.settings.imageSrc),this._super()},zoomFit:function(){var e,t,n,i,r,o,a,s=this;a=10,e=s.$el.find("img"),t=s.getEl().clientWidth,n=s.getEl().clientHeight,i=e[0].naturalWidth,r=e[0].naturalHeight,o=Math.min((t-a)/i,(n-a)/r),o>=1&&(o=1),s.zoom(o)},repaintImage:function(){var e,t,n,i,r,o,a,s,l,c,u;u=this.getEl(),l=this.zoom(),c=this.state.get("rect"),a=this.$el.find("img"),s=this.$el.find(".mce-imagepanel-bg"),r=u.offsetWidth,o=u.offsetHeight,n=a[0].naturalWidth*l,i=a[0].naturalHeight*l,e=Math.max(0,r/2-n/2),t=Math.max(0,o/2-i/2),a.css({left:e,top:t,width:n,height:i}),s.css({left:e,top:t,width:n,height:i}),this.cropRect&&(this.cropRect.setRect({x:c.x*l+e,y:c.y*l+t,w:c.w*l,h:c.h*l}),this.cropRect.setClampRect({x:e,y:t,w:n,h:i}),this.cropRect.setViewPortRect({x:0,y:0,w:r,h:o}))},bindStates:function(){function e(e){t.cropRect=new o(e,t.state.get("viewRect"),t.state.get("viewRect"),t.getEl(),function(){t.fire("crop")}),t.cropRect.on("updateRect",function(e){var n=e.rect,i=t.zoom();n={x:Math.round(n.x/i),y:Math.round(n.y/i),w:Math.round(n.w/i),h:Math.round(n.h/i)},t.state.set("rect",n)}),t.on("remove",t.cropRect.destroy)}var t=this;t.state.on("change:cropEnabled",function(e){t.cropRect.toggleVisibility(e.value),t.repaintImage()}),t.state.on("change:zoom",function(){t.repaintImage()}),t.state.on("change:rect",function(n){var i=n.value;t.cropRect||e(i),t.cropRect.setRect(i)})}})}),a("k",[],function(){return function(){function e(e){var t;return t=o.splice(++a),o.push(e),{state:e,removed:t}}function t(){if(i())return o[--a]}function n(){if(r())return o[++a]}function i(){return a>0}function r(){return a!=-1&&a<o.length-1}var o=[],a=-1;return{data:o,add:e,undo:t,redo:n,canUndo:i,canRedo:r}}}),a("9",["f","5","3","g","h","i","j","7","8","k"],function(e,t,n,i,r,o,a,s,l,c){function u(e){return{blob:e,url:URL.createObjectURL(e)}}function d(e){e&&URL.revokeObjectURL(e.url)}function f(e){t.each(e,d)}function h(n,l,h){function p(e){var t,n,i,r;t=L.find("#w")[0],n=L.find("#h")[0],i=parseInt(t.value(),10),r=parseInt(n.value(),10),L.find("#constrain")[0].checked()&&ae&&se&&i&&r&&("w"==e.control.settings.name?(r=Math.round(i*le),n.value(r)):(i=Math.round(r*ce),t.value(i))),ae=i,se=r}function m(e){return Math.round(100*e)+"%"}function g(){L.find("#undo").disabled(!ue.canUndo()),L.find("#redo").disabled(!ue.canRedo()),L.statusbar.find("#save").disabled(!ue.canUndo())}function v(){L.find("#undo").disabled(!0),L.find("#redo").disabled(!0)}function y(e){e&&$.imageSrc(e.url)}function b(e){return function(){var n=t.grep(oe,function(t){return t.settings.name!=e});t.each(n,function(e){e.hide()}),e.show(),e.focus()}}function C(e){z=u(e),y(z)}function w(e){n=u(e),y(n),f(ue.add(n).removed),g()}function x(){var e=$.selection();s.crop(n.blob,e.x,e.y,e.w,e.h).then(function(e){w(e),k()})}function _(e){var t=[].slice.call(arguments,1);return function(){var i=z||n;e.apply(this,[i.blob].concat(t)).then(C)}}function S(e){var t=[].slice.call(arguments,1);return function(){e.apply(this,[n.blob].concat(t)).then(w)}}function k(){y(n),d(z),b(O)(),g()}function E(){z&&(w(z.blob),k())}function T(){var e=$.zoom();e<2&&(e+=.1),$.zoom(e)}function N(){var e=$.zoom();e>.1&&(e-=.1),$.zoom(e)}function D(){n=ue.undo(),y(n),g()}function R(){n=ue.redo(),y(n),g()}function A(){l(n.blob),L.close()}function M(e){return new r({layout:"flex",direction:"row",labelGap:5,border:"0 0 1 0",align:"center",pack:"center",padding:"0 10 0 10",spacing:5,flex:0,minHeight:60,defaults:{classes:"imagetool",type:"button"},items:e})}function B(e,t){return M([{text:"Back",onclick:k},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:E}]).hide().on("show",function(){v(),t(n.blob).then(function(e){var t=u(e);y(t),d(z),z=t})})}function P(e,t,i,r,o){function a(e){t(n.blob,e).then(function(e){var t=u(e);y(t),d(z),z=t})}return M([{text:"Back",onclick:k},{type:"spacer",flex:1},{type:"slider",flex:1,ondragend:function(e){a(e.value)},minValue:r,maxValue:o,value:i,previewFilter:m},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:E}]).hide().on("show",function(){this.find("slider").value(i),v()})}function I(e,t){function i(){var e,i,r;e=L.find("#r")[0].value(),i=L.find("#g")[0].value(),r=L.find("#b")[0].value(),t(n.blob,e,i,r).then(function(e){var t=u(e);y(t),d(z),z=t})}return M([{text:"Back",onclick:k},{type:"spacer",flex:1},{type:"slider",label:"R",name:"r",minValue:0,value:1,maxValue:2,ondragend:i,previewFilter:m},{type:"slider",label:"G",name:"g",minValue:0,value:1,maxValue:2,ondragend:i,previewFilter:m},{type:"slider",label:"B",name:"b",minValue:0,value:1,maxValue:2,ondragend:i,previewFilter:m},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:E}]).hide().on("show",function(){L.find("#r,#g,#b").value(1),v()})}function H(e){e.control.value()===!0&&(le=se/ae,ce=ae/se)}var L,O,F,z,W,U,j,$,V,q,Y,G,X,K,Q,J,Z,ee,te,ne,ie,re,oe,ae,se,le,ce,ue=new c;W=M([{text:"Back",onclick:k},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:x}]).hide().on("show hide",function(e){$.toggleCropRect("show"==e.type)}).on("show",v),U=M([{text:"Back",onclick:k},{type:"spacer",flex:1},{type:"textbox",name:"w",label:"Width",size:4,onkeyup:p},{type:"textbox",name:"h",label:"Height",size:4,onkeyup:p},{type:"checkbox",name:"constrain",text:"Constrain proportions",checked:!0,onchange:H},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:"submit"}]).hide().on("submit",function(e){var t=parseInt(L.find("#w").value(),10),n=parseInt(L.find("#h").value(),10);e.preventDefault(),S(s.resize,t,n)(),k()}).on("show",v),j=M([{text:"Back",onclick:k},{type:"spacer",flex:1},{icon:"fliph",tooltip:"Flip horizontally",onclick:_(s.flip,"h")},{icon:"flipv",tooltip:"Flip vertically",onclick:_(s.flip,"v")},{icon:"rotateleft",tooltip:"Rotate counterclockwise",onclick:_(s.rotate,-90)},{icon:"rotateright",tooltip:"Rotate clockwise",onclick:_(s.rotate,90)},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:E}]).hide().on("show",v),Y=B("Invert",s.invert),te=B("Sharpen",s.sharpen),ne=B("Emboss",s.emboss),G=P("Brightness",s.brightness,0,-1,1),X=P("Hue",s.hue,180,0,360),K=P("Saturate",s.saturate,0,-1,1),Q=P("Contrast",s.contrast,0,-1,1),J=P("Grayscale",s.grayscale,0,0,1),Z=P("Sepia",s.sepia,0,0,1),ee=I("Colorize",s.colorize),ie=P("Gamma",s.gamma,0,-1,1),re=P("Exposure",s.exposure,1,0,2),F=M([{text:"Back",onclick:k},{type:"spacer",flex:1},{text:"hue",icon:"hue",onclick:b(X)},{text:"saturate",icon:"saturate",onclick:b(K)},{text:"sepia",icon:"sepia",onclick:b(Z)},{text:"emboss",icon:"emboss",onclick:b(ne)},{text:"exposure",icon:"exposure",onclick:b(re)},{type:"spacer",flex:1}]).hide(),O=M([{tooltip:"Crop",icon:"crop",onclick:b(W)},{tooltip:"Resize",icon:"resize2",onclick:b(U)},{tooltip:"Orientation",icon:"orientation",onclick:b(j)},{tooltip:"Brightness",icon:"sun",onclick:b(G)},{tooltip:"Sharpen",icon:"sharpen",onclick:b(te)},{tooltip:"Contrast",icon:"contrast",onclick:b(Q)},{tooltip:"Color levels",icon:"drop",onclick:b(ee)},{tooltip:"Gamma",icon:"gamma",onclick:b(ie)},{tooltip:"Invert",icon:"invert",onclick:b(Y)}]),$=new a({flex:1,imageSrc:n.url}),V=new o({layout:"flex",direction:"column",border:"0 1 0 0",padding:5,spacing:5,items:[{type:"button",icon:"undo",tooltip:"Undo",name:"undo",onclick:D},{type:"button",icon:"redo",tooltip:"Redo",name:"redo",onclick:R},{type:"button",icon:"zoomin",tooltip:"Zoom in",onclick:T},{type:"button",icon:"zoomout",tooltip:"Zoom out",onclick:N}]}),q=new o({type:"container",layout:"flex",direction:"row",align:"stretch",flex:1,items:[V,$]}),oe=[O,W,U,j,F,Y,G,X,K,Q,J,Z,ee,te,ne,ie,re],L=i.create("window",{layout:"flex",direction:"column",align:"stretch",minWidth:Math.min(e.DOM.getViewPort().w,800),minHeight:Math.min(e.DOM.getViewPort().h,650),title:"Edit image",items:oe.concat([q]),buttons:[{text:"Save",name:"save",subtype:"primary",onclick:A},{text:"Cancel",onclick:"close"}]}),L.renderTo(document.body).reflow(),L.on("close",function(){h(),f(ue.data),ue=null,z=null}),ue.add(n),g(),$.on("load",function(){ae=$.imageSize().w,se=$.imageSize().h,le=se/ae,ce=ae/se,L.find("#w").value(ae),L.find("#h").value(se)}),$.on("crop",x)}function p(e){return new n(function(t,n){h(u(e),t,n)})}return{edit:p}}),a("a",[],function(){function e(e){function t(e){return/^[0-9\.]+px$/.test(e)}var n,i;return n=e.style.width,i=e.style.height,n||i?t(n)&&t(i)?{w:parseInt(n,10),h:parseInt(i,10)}:null:(n=e.width,i=e.height,n&&i?{w:parseInt(n,10),h:parseInt(i,10)}:null)}function t(e,t){var n,i;t&&(n=e.style.width,i=e.style.height,(n||i)&&(e.style.width=t.w+"px",e.style.height=t.h+"px",e.removeAttribute("data-mce-style")),n=e.width,i=e.height,(n||i)&&(e.setAttribute("width",t.w),e.setAttribute("height",t.h)))}function n(e){return{w:e.naturalWidth,h:e.naturalHeight}}return{getImageSize:e,setImageSize:t,getNaturalImageSize:n}}),a("l",["3","5"],function(e,t){var n=function(e){return null!==e&&void 0!==e},i=function(e,t){var i;return i=t.reduce(function(e,t){return n(e)?e[t]:void 0},e),n(i)?i:null},r=function(n,i){return new e(function(e){var r;r=new XMLHttpRequest,r.onreadystatechange=function(){4===r.readyState&&e({status:r.status,blob:this.response})},r.open("GET",n,!0),t.each(i,function(e,t){r.setRequestHeader(t,e)}),r.responseType="blob",r.send()})},o=function(t){return new e(function(e){var n=new FileReader;n.onload=function(t){var n=t.target;e(n.result)},n.readAsText(t)})},a=function(e){var t;try{t=JSON.parse(e)}catch(e){}return t};return{traverse:i,readBlob:o,requestUrlAsBlob:r,parseJson:a}}),a("b",["3","5","l"],function(e,t,n){function i(t){return n.requestUrlAsBlob(t,{}).then(function(t){return t.status>=400?o(t.status):e.resolve(t.blob)})}var r=function(e){return 400===e||403===e||500===e},o=function(t){return e.reject("ImageProxy HTTP error: "+t)},a=function(t){e.reject("ImageProxy Service error: "+t)},s=function(e,t){return n.readBlob(t).then(function(e){var t=n.parseJson(e),i=n.traverse(t,["error","type"]);return a(i?i:"Invalid JSON")})},l=function(e,t){return r(e)?s(e,t):o(e)},c=function(t,i){return n.requestUrlAsBlob(t,{"Content-Type":"application/json;charset=UTF-8","tiny-api-key":i}).then(function(t){return t.status>=400?l(t.status,t.blob):e.resolve(t.blob)})},u=function(e,t){return t?c(e,t):i(e)};return{getUrl:u}}),a("0",["1","2","3","4","5","6","7","8","9","a","b"],function(e,t,n,i,r,o,a,s,l,c,u){var d=function(e){function d(t){e.notificationManager.open({text:t,type:"error"})}function f(){return e.selection.getNode()}function h(t){var n=t.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i);return n?e.dom.encode(n[1]):null}function p(){return"imagetools"+B++}function m(t){var n=t.src;return 0===n.indexOf("data:")||0===n.indexOf("blob:")||new i(n).host===e.documentBaseURI.host}function g(t){return r.inArray(e.settings.imagetools_cors_hosts,new i(t.src).host)!==-1}function v(){return e.settings.api_key||e.settings.imagetools_api_key}function y(t){var n,i=t.src;return g(t)?u.getUrl(t.src,null):m(t)?s.imageToBlob(t):(i=e.settings.imagetools_proxy,i+=(i.indexOf("?")===-1?"?":"&")+"url="+encodeURIComponent(t.src),n=v(),u.getUrl(i,n))}function b(){var t;return t=e.editorUpload.blobCache.getByUri(f().src),t?t.blob():y(f())}function C(){A=o.setEditorTimeout(e,function(){e.editorUpload.uploadImagesAuto()},e.settings.images_upload_timeout||3e4)}function w(){clearTimeout(A)}function x(t,n){return s.blobToDataUri(t).then(function(r){var o,a,s,l,c,u;return u=f(),l=e.editorUpload.blobCache,c=l.getByUri(u.src),s=i.parseDataUri(r).data,o=p(),e.settings.images_reuse_filename&&(a=c?c.filename():h(u.src)),c=l.create(o,t,s,a),l.add(c),e.undoManager.transact(function(){function t(){e.$(u).off("load",t),e.nodeChanged(),n?e.editorUpload.uploadImagesAuto():(w(),C())}e.$(u).on("load",t),e.$(u).attr({src:c.blobUri()}).removeAttr("data-mce-src")}),c})}function _(t){return function(){return e._scanForImages().then(b).then(t).then(x,d)}}function S(e){return function(){return _(function(t){var n=c.getImageSize(f());return n&&c.setImageSize(f(),{w:n.h,h:n.w}),a.rotate(t,e)})()}}function k(e){return function(){return _(function(t){return a.flip(t,e)})()}}function E(){var e=f(),t=c.getNaturalImageSize(e),i=function(i){return new n(function(n){s.blobToImage(i).then(function(r){var o=c.getNaturalImageSize(r);t.w==o.w&&t.h==o.h||c.getImageSize(e)&&c.setImageSize(e,o),URL.revokeObjectURL(r.src),n(i)})})},r=function(e){return l.edit(e).then(i).then(function(e){x(e,!0)},function(){})};e&&y(e).then(r,d)}function T(){e.addButton("rotateleft",{title:"Rotate counterclockwise",cmd:"mceImageRotateLeft"}),e.addButton("rotateright",{title:"Rotate clockwise",cmd:"mceImageRotateRight"}),e.addButton("flipv",{title:"Flip vertically",cmd:"mceImageFlipVertical"}),e.addButton("fliph",{title:"Flip horizontally",cmd:"mceImageFlipHorizontal"}),e.addButton("editimage",{title:"Edit image",cmd:"mceEditImage"}),e.addButton("imageoptions",{title:"Image options",icon:"options",cmd:"mceImage"})}function N(){e.on("NodeChange",function(t){M&&M.src!=t.element.src&&(w(),e.editorUpload.uploadImagesAuto(),M=void 0),D(t.element)&&(M=t.element)})}function D(t){var n=e.dom.is(t,"img:not([data-mce-object],[data-mce-placeholder])");return n&&(m(t)||g(t)||e.settings.imagetools_proxy)}function R(){var t=e.settings.imagetools_toolbar;t||(t="rotateleft rotateright | flipv fliph | crop editimage imageoptions"),e.addContextToolbar(D,t)}var A,M,B=0;t.fileApi&&(r.each({mceImageRotateLeft:S(-90),mceImageRotateRight:S(90),mceImageFlipVertical:k("v"),mceImageFlipHorizontal:k("h"),mceEditImage:E},function(t,n){e.addCommand(n,t)}),T(),R(),N())};return e.add("imagetools",d),function(){}}),i("0")()}();