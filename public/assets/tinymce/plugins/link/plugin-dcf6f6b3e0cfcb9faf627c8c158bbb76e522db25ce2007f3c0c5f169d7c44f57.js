tinymce.PluginManager.add("link",function(e){function t(e){return e&&"A"===e.nodeName&&e.href}function n(e){return tinymce.util.Tools.grep(e,t).length>0}function i(t){return e.dom.getParent(t,"a[href]")}function r(){return i(e.selection.getStart())}function o(e){var t=e.getAttribute("data-mce-href");return t?t:e.getAttribute("href")}function a(){var t=e.plugins.contextmenu;return!!t&&t.isContextMenuVisible()}function s(n){var i,r,o;return!!(e.settings.link_context_toolbar&&!a()&&t(n)&&(i=e.selection,r=i.getRng(),o=r.startContainer,3==o.nodeType&&i.isCollapsed()&&r.startOffset>0&&r.startOffset<o.data.length))}function l(e,t){document.body.appendChild(e),e.dispatchEvent(t),document.body.removeChild(e)}function c(e){if(!tinymce.Env.ie||tinymce.Env.ie>10){var t=document.createElement("a");t.target="_blank",t.href=e,t.rel="noreferrer noopener";var n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),l(t,n)}else{var i=window.open("","_blank");if(i){i.opener=null;var r=i.document;r.open(),r.write('<meta http-equiv="refresh" content="0; url='+tinymce.DOM.encode(e)+'">'),r.close()}}}function u(t){if(t){var n=o(t);if(/^#/.test(n)){var i=e.$(n);i.length&&e.selection.scrollIntoView(i[0],!0)}else c(t.href)}}function d(){u(r())}function f(){var t=this,i=function(e){n(e.parents)?t.show():t.hide()};n(e.dom.getParents(e.selection.getStart()))||t.hide(),e.on("nodechange",i),t.on("remove",function(){e.off("nodechange",i)})}function h(t){return function(){var n=e.settings.link_list;"string"==typeof n?tinymce.util.XHR.send({url:n,success:function(e){t(tinymce.util.JSON.parse(e))}}):"function"==typeof n?n(t):t(n)}}function p(e,t,n){function i(e,n){return n=n||[],tinymce.each(e,function(e){var r={text:e.text||e.title};e.menu?r.menu=i(e.menu):(r.value=e.value,t&&t(r)),n.push(r)}),n}return i(e,n||[])}function m(t){function n(e){var t=d.find("#text");(!t.value()||e.lastControl&&t.value()==e.lastControl.text())&&t.value(e.control.text()),d.find("#href").value(e.control.value())}function i(t){var i=[];if(tinymce.each(e.dom.select("a:not([href])"),function(e){var n=e.name||e.id;n&&i.push({text:n,value:"#"+n,selected:t.indexOf("#"+n)!=-1})}),i.length)return i.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:i,onselect:n}}function r(){!u&&0===x.text.length&&f&&this.parent().parent().find("#text")[0].value(this.value())}function o(t){var n=t.meta||{};m&&m.value(e.convertURL(this.value(),"href")),tinymce.each(t.meta,function(e,t){var n=d.find("#"+t);"text"===t?0===u.length&&(n.value(e),x.text=e):n.value(e)}),n.attach&&(g={href:this.value(),attach:n.attach}),n.text||r.call(this)}function a(e){var t=_.getContent();if(/</.test(t)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(t)||t.indexOf("href=")==-1))return!1;if(e){var n,i=e.childNodes;if(0===i.length)return!1;for(n=i.length-1;n>=0;n--)if(3!=i[n].nodeType)return!1}return!0}function s(e){e.meta=d.toJSON()}var l,c,u,d,f,h,m,v,y,b,C,w,x={},_=e.selection,S=e.dom;l=_.getNode(),c=S.getParent(l,"a[href]"),f=a(),x.text=u=c?c.innerText||c.textContent:_.getContent({format:"text"}),x.href=c?S.getAttrib(c,"href"):"",c?x.target=S.getAttrib(c,"target"):e.settings.default_link_target&&(x.target=e.settings.default_link_target),(w=S.getAttrib(c,"rel"))&&(x.rel=w),(w=S.getAttrib(c,"class"))&&(x["class"]=w),(w=S.getAttrib(c,"title"))&&(x.title=w),f&&(h={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){x.text=this.value()}}),t&&(m={type:"listbox",label:"Link list",values:p(t,function(t){t.value=e.convertURL(t.value||t.url,"href")},[{text:"None",value:""}]),onselect:n,value:e.convertURL(x.href,"href"),onPostRender:function(){m=this}}),e.settings.target_list!==!1&&(e.settings.target_list||(e.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]),y={name:"target",type:"listbox",label:"Target",values:p(e.settings.target_list)}),e.settings.rel_list&&(v={name:"rel",type:"listbox",label:"Rel",values:p(e.settings.rel_list)}),e.settings.link_class_list&&(b={name:"class",type:"listbox",label:"Class",values:p(e.settings.link_class_list,function(t){t.value&&(t.textStyle=function(){return e.formatter.getCssText({inline:"a",classes:[t.value]})})})}),e.settings.link_title!==!1&&(C={name:"title",type:"textbox",label:"Title",value:x.title}),d=e.windowManager.open({title:"Insert link",data:x,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:o,onkeyup:r,onbeforecall:s},h,C,i(x.href),m,v,y,b],onSubmit:function(t){function n(t,n){var i=e.selection.getRng();tinymce.util.Delay.setEditorTimeout(e,function(){e.windowManager.confirm(t,function(t){e.selection.setRng(i),n(t)})})}function i(e,t){function n(e){return e=i(e),e?[e,r].join(" "):r}function i(e){var t=new RegExp("("+r.replace(" ","|")+")","g");return e&&(e=tinymce.trim(e.replace(t,""))),e?e:null}var r="noopener noreferrer";return t?n(e):i(e)}function r(){var t={href:a,target:x.target?x.target:null,rel:x.rel?x.rel:null,"class":x["class"]?x["class"]:null,title:x.title?x.title:null};e.settings.allow_unsafe_link_target||(t.rel=i(t.rel,"_blank"==t.target)),a===g.href&&(g.attach(),g={}),c?(e.focus(),f&&x.text!=u&&("innerText"in c?c.innerText=x.text:c.textContent=x.text),S.setAttribs(c,t),_.select(c),e.undoManager.add()):f?e.insertContent(S.createHTML("a",t,S.encode(x.text))):e.execCommand("mceInsertLink",!1,t)}function o(){e.undoManager.transact(r)}var a;return x=tinymce.extend(x,t.data),(a=x.href)?a.indexOf("@")>0&&a.indexOf("//")==-1&&a.indexOf("mailto:")==-1?void n("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(e){e&&(a="mailto:"+a),o()}):e.settings.link_assume_external_targets&&!/^\w+:/i.test(a)||!e.settings.link_assume_external_targets&&/^\s*www[\.|\d\.]/i.test(a)?void n("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(e){e&&(a="http://"+a),o()}):void o():void e.execCommand("unlink")}})}var g={},v=function(e){return e.altKey===!0&&e.shiftKey===!1&&e.ctrlKey===!1&&e.metaKey===!1};e.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:h(m),stateSelector:"a[href]"}),e.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),e.addContextToolbar&&(e.addButton("openlink",{icon:"newtab",tooltip:"Open link",onclick:d}),e.addContextToolbar(s,"openlink | link unlink")),e.addShortcut("Meta+K","",h(m)),e.addCommand("mceLink",h(m)),e.on("click",function(e){var t=i(e.target);t&&tinymce.util.VK.metaKeyPressed(e)&&(e.preventDefault(),u(t))}),e.on("keydown",function(e){var t=r();t&&13===e.keyCode&&v(e)&&(e.preventDefault(),u(t))}),this.showDialog=m,e.addMenuItem("openlink",{text:"Open link",icon:"newtab",onclick:d,onPostRender:f,prependToContext:!0}),e.addMenuItem("link",{icon:"link",text:"Link",shortcut:"Meta+K",onclick:h(m),stateSelector:"a[href]",context:"insert",prependToContext:!0})});